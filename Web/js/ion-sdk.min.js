var IonSDK=function(t){var e={};function i(s){if(e[s])return e[s].exports;var a=e[s]={i:s,l:!1,exports:{}};return t[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)i.d(s,a,function(e){return t[e]}.bind(null,a));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=1)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.makeRemote=e.LocalStream=e.VideoConstraints=void 0;const s=["qvga","vga","shd","hd","fhd","qhd"];e.VideoConstraints={qvga:{resolution:{width:{ideal:320},height:{ideal:180},frameRate:{ideal:15,max:30}},encodings:{maxBitrate:15e4,maxFramerate:15}},vga:{resolution:{width:{ideal:640},height:{ideal:360},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:5e5,maxFramerate:30}},shd:{resolution:{width:{ideal:960},height:{ideal:540},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:12e5,maxFramerate:30}},hd:{resolution:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:25e5,maxFramerate:30}},fhd:{resolution:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:4e6,maxFramerate:30}},qhd:{resolution:{width:{ideal:2560},height:{ideal:1440},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:8e6,maxFramerate:30}}};const a={resolution:"hd",codec:"vp8",audio:!0,video:!0,simulcast:!1};class r extends MediaStream{constructor(t,e){super(t),this.constraints=e}static async getUserMedia(t=a){const e=await navigator.mediaDevices.getUserMedia({audio:r.computeAudioConstraints({...a,...t}),video:r.computeVideoConstraints({...a,...t})});return new r(e,{...a,...t})}static async getDisplayMedia(t={codec:"vp8",resolution:"hd",audio:!1,video:!0,simulcast:!1}){const e=await navigator.mediaDevices.getDisplayMedia(t);return new r(e,{...a,...t})}static computeAudioConstraints(t){return t.audio}static computeVideoConstraints(t){return t.video instanceof Object?t.video:t.video&&t.resolution?{...e.VideoConstraints[t.resolution].resolution}:t.video}getTrack(t){let e;return"video"===t?(e=this.getVideoTracks(),e.length>0?this.getVideoTracks()[0]:void 0):(e=this.getAudioTracks(),e.length>0?this.getAudioTracks()[0]:void 0)}async getNewTrack(t){return(await navigator.mediaDevices.getUserMedia({[t]:"video"===t?r.computeVideoConstraints(this.constraints):r.computeAudioConstraints(this.constraints)})).getTracks()[0]}publishTrack(t){if(this.pc)if("video"===t.kind&&this.constraints.simulcast){const i=s.indexOf(this.constraints.resolution),a=[{rid:"f",maxBitrate:e.VideoConstraints[s[i]].encodings.maxBitrate,maxFramerate:e.VideoConstraints[s[i]].encodings.maxFramerate}];i-1>=0&&a.push({rid:"h",scaleResolutionDownBy:2,maxBitrate:e.VideoConstraints[s[i-1]].encodings.maxBitrate,maxFramerate:e.VideoConstraints[s[i-1]].encodings.maxFramerate}),i-2>=0&&a.push({rid:"q",scaleResolutionDownBy:4,maxBitrate:e.VideoConstraints[s[i-2]].encodings.maxBitrate,maxFramerate:e.VideoConstraints[s[i-2]].encodings.maxFramerate});const r=this.pc.addTransceiver(t,{streams:[this],direction:"sendonly",sendEncodings:a});this.setPreferredCodec(r,t.kind)}else{const i={streams:[this],direction:"sendonly"};"video"===t.kind&&(i.sendEncodings=[e.VideoConstraints[this.constraints.resolution].encodings]);const s=this.pc.addTransceiver(t,i);this.setPreferredCodec(s,t.kind)}}setPreferredCodec(t,e){if("setCodecPreferences"in t){const i=RTCRtpSender.getCapabilities(e);if(!i)return;let s;if(this.constraints.preferredCodecProfile&&"video"===e){const t=i.codecs.filter(t=>t.mimeType.toLowerCase()==="video/"+this.constraints.codec.toLowerCase());if(!t)return;s=t.find(t=>{var e;return t.sdpFmtpLine&&(null===(e=t.sdpFmtpLine)||void 0===e?void 0:e.indexOf("profile-level-id="+this.constraints.preferredCodecProfile))>=0}),s||(s=t[0])}else s=i.codecs.find(t=>t.mimeType.toLowerCase()==="video/"+this.constraints.codec.toLowerCase()||"audio/opus"===t.mimeType.toLowerCase());s&&t.setCodecPreferences([s])}}updateTrack(t,e){this.addTrack(t),e?(this.removeTrack(e),e.stop(),this.pc&&this.pc.getSenders().forEach(async e=>{var i,s;(null===(i=null==e?void 0:e.track)||void 0===i?void 0:i.kind)===t.kind&&(null===(s=e.track)||void 0===s||s.stop(),e.replaceTrack(t))})):(this.addTrack(t),this.pc&&this.publishTrack(t))}initAudioEmptyTrack(){const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator();e.frequency.setValueAtTime(2e4,t.currentTime);const i=e.connect(t.createMediaStreamDestination());return e.start(),i.stream.getAudioTracks()[0]}initVideoEmptyTrack(t,e){var i;const s=Object.assign(document.createElement("canvas"),{width:t,height:e});null===(i=s.getContext("2d"))||void 0===i||i.fillRect(0,0,t,e);return s.captureStream().getVideoTracks()[0]}publish(t){this.pc=t,this.getTracks().forEach(this.publishTrack.bind(this))}unpublish(){if(this.pc){const t=this.getTracks();this.pc.getSenders().forEach(e=>{e.track&&t.includes(e.track)&&this.pc.removeTrack(e)})}}async switchDevice(t,e){this.constraints={...this.constraints,[t]:this.constraints[t]instanceof Object?{...this.constraints[t],deviceId:e}:{deviceId:e}};const i=this.getTrack(t),s=await this.getNewTrack(t);this.updateTrack(s,i)}mute(t){const e=this.getTrack(t);if(e&&this.constraints.sendEmptyOnMute){const i="audio"===t?this.initAudioEmptyTrack():this.initVideoEmptyTrack((null==e?void 0:e.getSettings().width)||640,(null==e?void 0:e.getSettings().height)||360);return i.enabled=!1,void this.updateTrack(i,e)}e&&e.stop()}async unmute(t){const e=this.getTrack(t),i=await this.getNewTrack(t);this.updateTrack(i,e)}updateMediaEncodingParams(t){this.pc&&this.getTracks().forEach(e=>{var i,s;const a=null===(s=null===(i=this.pc)||void 0===i?void 0:i.getSenders())||void 0===s?void 0:s.filter(t=>{var i;return e.id===(null===(i=t.track)||void 0===i?void 0:i.id)});null==a||a.forEach(e=>{const i=e.getParameters();i.encodings||(i.encodings=[{}]),i.encodings[0]={...i.encodings[0],...t},e.setParameters(i)})})}}e.LocalStream=r,e.makeRemote=function(t,e){const i=t;i.audio=!0,i.video="none",i.framerate="high",i._videoPreMute="high";const s=()=>{const t={streamId:i.id,video:i.video,audio:i.audio,framerate:i.framerate};e.api&&("open"!==e.api.readyState?e.api.onopen=()=>{var i;return null===(i=e.api)||void 0===i?void 0:i.send(JSON.stringify(t))}:e.api.send(JSON.stringify(t)))};return i.preferLayer=t=>{i.video=t,s()},i.preferFramerate=t=>{i.framerate=t,s()},i.mute=t=>{"audio"===t?i.audio=!1:"video"===t&&(i._videoPreMute=i.video,i.video="none"),s()},i.unmute=t=>{"audio"===t?i.audio=!0:"video"===t&&(i.video=i._videoPreMute),s()},i}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LocalStream=e.Client=void 0;const s=i(2);e.Client=s.default;const a=i(0);Object.defineProperty(e,"LocalStream",{enumerable:!0,get:function(){return a.LocalStream}})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Transport=void 0;const s=i(0),a="no active session, join first";var r;!function(t){t[t.pub=0]="pub",t[t.sub=1]="sub"}(r||(r={}));class n{constructor(t,e,i){this.signal=e,this.pc=new RTCPeerConnection(i),this.candidates=[],t===r.pub&&this.pc.createDataChannel("ion-sfu"),this.pc.onicecandidate=({candidate:e})=>{e&&this.signal.trickle({target:t,candidate:e})},this.pc.oniceconnectionstatechange=async t=>{"disconnected"===this.pc.iceConnectionState&&this.pc.restartIce&&this.pc.restartIce()}}}e.Transport=n;e.default=class{constructor(t,e={codec:"vp8",iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}]}){this.signal=t,this.config=e,t.onnegotiate=this.negotiate.bind(this),t.ontrickle=this.trickle.bind(this)}async join(t,e){this.transports={[r.pub]:new n(r.pub,this.signal,this.config),[r.sub]:new n(r.sub,this.signal,this.config)},this.transports[r.sub].pc.ontrack=t=>{const e=t.streams[0],i=s.makeRemote(e,this.transports[r.sub]);this.ontrack&&this.ontrack(t.track,i)},this.transports[r.sub].pc.ondatachannel=t=>{if("ion-sfu"===t.channel.label)return this.transports[r.sub].api=t.channel,void(t.channel.onmessage=t=>{this.onspeaker&&this.onspeaker(JSON.parse(t.data))});this.ondatachannel&&this.ondatachannel(t)};const i=await this.transports[r.pub].pc.createOffer();await this.transports[r.pub].pc.setLocalDescription(i);const a=await this.signal.join(t,e,i);await this.transports[r.pub].pc.setRemoteDescription(a),this.transports[r.pub].candidates.forEach(t=>this.transports[r.pub].pc.addIceCandidate(t)),this.transports[r.pub].pc.onnegotiationneeded=this.onNegotiationNeeded.bind(this)}leave(){this.transports&&(Object.values(this.transports).forEach(t=>t.pc.close()),delete this.transports)}getPubStats(t){if(!this.transports)throw Error(a);return this.transports[r.pub].pc.getStats(t)}getSubStats(t){if(!this.transports)throw Error(a);return this.transports[r.sub].pc.getStats(t)}publish(t){if(!this.transports)throw Error(a);t.publish(this.transports[r.pub].pc)}createDataChannel(t){if(!this.transports)throw Error(a);return this.transports[r.pub].pc.createDataChannel(t)}close(){this.transports&&Object.values(this.transports).forEach(t=>t.pc.close()),this.signal.close()}trickle({candidate:t,target:e}){if(!this.transports)throw Error(a);this.transports[e].pc.remoteDescription?this.transports[e].pc.addIceCandidate(t):this.transports[e].candidates.push(t)}async negotiate(t){if(!this.transports)throw Error(a);let e;try{await this.transports[r.sub].pc.setRemoteDescription(t),this.transports[r.sub].candidates.forEach(t=>this.transports[r.sub].pc.addIceCandidate(t)),this.transports[r.sub].candidates=[],e=await this.transports[r.sub].pc.createAnswer(),await this.transports[r.sub].pc.setLocalDescription(e),this.signal.answer(e)}catch(i){console.error(i),this.onerrnegotiate&&this.onerrnegotiate(r.sub,i,t,e)}}async onNegotiationNeeded(){if(!this.transports)throw Error(a);let t,e;try{t=await this.transports[r.pub].pc.createOffer(),await this.transports[r.pub].pc.setLocalDescription(t),e=await this.signal.offer(t),await this.transports[r.pub].pc.setRemoteDescription(e)}catch(i){console.error(i),this.onerrnegotiate&&this.onerrnegotiate(r.pub,i,t,e)}}}}]);
//# sourceMappingURL=ion-sdk.min.js.map